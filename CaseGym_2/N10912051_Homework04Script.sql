/* STUDENT NAME: CHEN-YUAN HO */
/* N NUMBER: N10912051 */

DROP TRIGGER TRIGGER01;
DROP TABLE ANSWER01;
DROP TABLE ANSWER02;
DROP TABLE ANSWER03;
DROP TABLE ANSWER04;
DROP TABLE ANSWER05;
DROP VIEW ANSWER05;

DROP TABLE TEMP0;
DROP TABLE TEMP1;
DROP TABLE TEMP2;
DROP TABLE TEMP3;
DROP TABLE TEMP4;
DROP TABLE TEMP5;
DROP TABLE TEMP6;
DROP TABLE TEMP7;
DROP TABLE TEMP8;
DROP TABLE TEMP9;
DROP TABLE TEMP10;
DROP TABLE TEMP11;
DROP TABLE TEMP12;
DROP TABLE TEMP13;
DROP TABLE TEMP14;
DROP TABLE TEMP15;
DROP TABLE TEMP16;
DROP TABLE TEMP17;
DROP TABLE TEMP18;
DROP TABLE TEMP19;
DROP TABLE TEMP20;

DROP TABLE TEACHES;
DROP TABLE BORROWS;
DROP TABLE EQUIPMENT;
DROP TABLE PRIZE;
DROP TABLE PROJECT;
DROP TABLE COURSE;
DROP TABLE COACH;
DROP TABLE MANAGER;
DROP TABLE MEMBER;
DROP TABLE PERSON;

CREATE TABLE PERSON (
	IDNUMBER CHAR(30) PRIMARY KEY,
	NAME CHAR(30) NOT NULL,
	PHONE CHAR(30)
);

CREATE TABLE MEMBER (
	IDNUMBER CHAR(30) PRIMARY KEY,
	STARTDATE CHAR(30) NOT NULL,
	ENDDATE CHAR(30) NOT NULL,
	MEMBERSHIP CHAR(30) NOT NULL,
	FOREIGN KEY (IDNUMBER) REFERENCES PERSON (IDNUMBER) ON DELETE CASCADE
);

CREATE TABLE MANAGER (
	IDNUMBER CHAR(30) PRIMARY KEY,
	LOCATION CHAR(30) NOT NULL,
	ROOMNUM CHAR(30) NOT NULL,
	EMAIL CHAR(30),
	FOREIGN KEY (IDNUMBER) REFERENCES PERSON (IDNUMBER) ON DELETE CASCADE
);

CREATE TABLE COACH (
	IDNUMBER CHAR(30) PRIMARY KEY,
	EMAIL CHAR(30) NOT NULL,
	LVL CHAR(30) NOT NULL,
	SUPERVISOR CHAR(30),
	FOREIGN KEY (IDNUMBER) REFERENCES PERSON (IDNUMBER) ON DELETE CASCADE,
	FOREIGN KEY (SUPERVISOR) REFERENCES MANAGER (IDNUMBER) ON DELETE CASCADE
);

CREATE TABLE COURSE (
	NAME CHAR(30) NOT NULL,
	LVL CHAR(30) NOT NULL,
	MAXSTUDENTS CHAR(30) NOT NULL,
	PRIMARY KEY (NAME, LVL)
);

CREATE TABLE PROJECT (
	NAME CHAR(30) NOT NULL,
	IDNUMBER CHAR(30) NOT NULL,
	PRIMARY KEY (NAME, IDNUMBER),
	FOREIGN KEY (IDNUMBER) REFERENCES MEMBER (IDNUMBER) ON DELETE CASCADE
);


CREATE TABLE PRIZE (
	PRIZEID CHAR(30) NOT NULL,
	NAME CHAR(30) NOT NULL,
	IDNUMBER CHAR(30) NOT NULL,
	PRIMARY KEY (PRIZEID, NAME, IDNUMBER),
	FOREIGN KEY (NAME, IDNUMBER) REFERENCES PROJECT (NAME, IDNUMBER) ON DELETE CASCADE
);


CREATE TABLE EQUIPMENT (
	NAME CHAR(30) PRIMARY KEY,
	IDNUMBER CHAR(30) NOT NULL,
	COURSENAME CHAR(30) NOT NULL,
	COURSELVL CHAR(30) NOT NULL,
	AMOUNT CHAR(30),
	USEAMOUNT CHAR(30),
	FOREIGN KEY (COURSENAME, COURSELVL) REFERENCES COURSE (NAME, LVL) ON DELETE CASCADE,
	FOREIGN KEY (IDNUMBER) REFERENCES MEMBER (IDNUMBER) ON DELETE CASCADE
);


CREATE TABLE BORROWS (
	EQUIPNAME CHAR(30) NOT NULL,
	PROJNAME CHAR(30) NOT NULL,
	MEMBERID CHAR(30) NOT NULL,
	DUE CHAR(30) NOT NULL,
	PRIMARY KEY (EQUIPNAME, PROJNAME, MEMBERID),
	FOREIGN KEY (EQUIPNAME) REFERENCES EQUIPMENT (NAME) ON DELETE CASCADE,
	FOREIGN KEY (PROJNAME, MEMBERID) REFERENCES PROJECT (NAME, IDNUMBER) ON DELETE CASCADE
);

CREATE TABLE TEACHES (
	NAME CHAR(30) NOT NULL,
	LVL CHAR(30) NOT NULL,
	IDNUMBER CHAR(30) NOT NULL,
	EVALUATORS CHAR(30),
	TEACHDATE CHAR(30),
	PRIMARY KEY (NAME, LVL, IDNUMBER),
	FOREIGN KEY (NAME, LVL) REFERENCES COURSE (NAME, LVL) ON DELETE CASCADE,
	FOREIGN KEY (EVALUATORS) REFERENCES COACH (IDNUMBER) ON DELETE CASCADE,
	FOREIGN KEY (IDNUMBER) REFERENCES COACH (IDNUMBER) ON DELETE CASCADE
);

INSERT INTO PERSON VALUES('101', 'Abigail Black', '8577633767');
INSERT INTO PERSON VALUES('102', 'Diane Fisher', '4965213467');
INSERT INTO PERSON VALUES('103', 'Penelope Nolan', null);
INSERT INTO PERSON VALUES('104', 'Steven Lewis', '7513675727');
INSERT INTO PERSON VALUES('105', 'Jane Ross', null);
INSERT INTO PERSON VALUES('106', 'Bernadette Morgan', '61118264563');
INSERT INTO PERSON VALUES('107', 'Lily Springer', null);
INSERT INTO PERSON VALUES('108', 'Zoe Smith', '3824469628');
INSERT INTO PERSON VALUES('109', 'Amanda Mackenzie', null);
INSERT INTO PERSON VALUES('110', 'Adrian Butler', '9976391944');
INSERT INTO PERSON VALUES('111', 'Abigail Black', null);
INSERT INTO PERSON VALUES('112', 'Hannah Black', '8948396935');
INSERT INTO PERSON VALUES('113', 'Vanessa Gill', '5257205498');
INSERT INTO PERSON VALUES('114', 'Bella Clark', '3841384625');
INSERT INTO PERSON VALUES('115', 'Jake Underwood', '6128465212');
INSERT INTO PERSON VALUES('116', 'Virgini Wright', null);
INSERT INTO PERSON VALUES('117', 'Joseph Young', '1794543929');
INSERT INTO PERSON VALUES('118', 'Dorothy Miller', '1795962125');
INSERT INTO PERSON VALUES('119', 'Dave Mitty', '8573399979');
INSERT INTO PERSON VALUES('120', 'Hilary Mason', null);

INSERT INTO MEMBER VALUES('101', TO_DATE('1/1/2017','MM/DD/YYYY'), TO_DATE('5/3/2017','MM/DD/YYYY'), 'planA');
INSERT INTO MEMBER VALUES('102', TO_DATE('2/6/2017','MM/DD/YYYY'), TO_DATE('8/12/2017','MM/DD/YYYY'), 'planB');
INSERT INTO MEMBER VALUES('104', TO_DATE('1/5/2016','MM/DD/YYYY'), TO_DATE('1/5/2017','MM/DD/YYYY'), 'planC');
INSERT INTO MEMBER VALUES('105', TO_DATE('4/3/2017','MM/DD/YYYY'), TO_DATE('5/3/2017','MM/DD/YYYY'), 'planC');
INSERT INTO MEMBER VALUES('106', TO_DATE('3/1/2017','MM/DD/YYYY'), TO_DATE('7/5/2017','MM/DD/YYYY'), 'planA');
INSERT INTO MEMBER VALUES('107', TO_DATE('12/1/2016','MM/DD/YYYY'), TO_DATE('1/1/2017','MM/DD/YYYY'), 'planA');
INSERT INTO MEMBER VALUES('110', TO_DATE('1/9/2017','MM/DD/YYYY'), TO_DATE('3/9/2017','MM/DD/YYYY'), 'planB');
INSERT INTO MEMBER VALUES('111', TO_DATE('11/1/2016','MM/DD/YYYY'), TO_DATE('3/1/2017','MM/DD/YYYY'), 'planC');
INSERT INTO MEMBER VALUES('112', TO_DATE('12/8/2016','MM/DD/YYYY'), TO_DATE('12/1/2017','MM/DD/YYYY'), 'planA');
INSERT INTO MEMBER VALUES('114', TO_DATE('4/1/2017','MM/DD/YYYY'), TO_DATE('4/27/2017','MM/DD/YYYY'), 'planB');
INSERT INTO MEMBER VALUES('117', TO_DATE('1/13/2016','MM/DD/YYYY'), TO_DATE('1/13/2017','MM/DD/YYYY'), 'planB');
INSERT INTO MEMBER VALUES('119', TO_DATE('2/5/2017','MM/DD/YYYY'), TO_DATE('4/5/2017','MM/DD/YYYY'), 'planA');

INSERT INTO MANAGER VALUES('101', 'New York City', '305', 'ablack@abc.com');
INSERT INTO MANAGER VALUES('103', 'Phoenix', '207', null);
INSERT INTO MANAGER VALUES('109', 'Seattle', '302', null);
INSERT INTO MANAGER VALUES('107', 'Seattle', '405', null);
INSERT INTO MANAGER VALUES('111', 'New York City', '208', 'zsmith@abc.com');
INSERT INTO MANAGER VALUES('112', 'Phoenix', '305', 'vgrill@abc.com');
INSERT INTO MANAGER VALUES('116', 'New York City', '203', 'jyoung@abc.com');
INSERT INTO MANAGER VALUES('118', 'Seattle', '107', 'dmiller@abc.com');

INSERT INTO COACH VALUES('102', 'dfisher@abc.com', '5', null);
INSERT INTO COACH VALUES('103', 'pnolan@abc.com', '3', '111');
INSERT INTO COACH VALUES('105', 'jross@abc.com', '4', '107');
INSERT INTO COACH VALUES('109', 'amackenzie@abc.com', '2', '111');
INSERT INTO COACH VALUES('111', 'ablack@abc.com', '4', '112');
INSERT INTO COACH VALUES('112', 'hblack@abc.com', '3', '116');
INSERT INTO COACH VALUES('114', 'bclark@abc.com', '1', null);
INSERT INTO COACH VALUES('115', 'junderwood@abc.com', '3', '101');
INSERT INTO COACH VALUES('116', 'vwright@abc.com', '2', '118');
INSERT INTO COACH VALUES('120', 'hmason@abc.com', '2', null);

INSERT INTO COURSE VALUES('Database Systems', '3', '30');
INSERT INTO COURSE VALUES('Machine Learning', '4', '20');
INSERT INTO COURSE VALUES('Algorithms', '2', '50');
INSERT INTO COURSE VALUES('Database Systems', '4', '30');
INSERT INTO COURSE VALUES('Distributed Systems', '3', '40');
INSERT INTO COURSE VALUES('Machine Learning', '1', '60');
INSERT INTO COURSE VALUES('Operating Systems', '2', '30');
INSERT INTO COURSE VALUES('Computer Vision', '3', '40');

INSERT INTO PROJECT VALUES('Data Analytics', '102');
INSERT INTO PROJECT VALUES('System Design', '105');
INSERT INTO PROJECT VALUES('Image Recognition', '106');
INSERT INTO PROJECT VALUES('System Optimization', '107');
INSERT INTO PROJECT VALUES('Data Prediction', '112');
INSERT INTO PROJECT VALUES('Data Search', '114');
INSERT INTO PROJECT VALUES('Software Development', '117');
INSERT INTO PROJECT VALUES('Image Reconstruction', '119');

INSERT INTO PRIZE VALUES('1001', 'Data Analytics', '102');
INSERT INTO PRIZE VALUES('1001', 'System Design', '105');
INSERT INTO PRIZE VALUES('1001', 'Data Search', '114');
INSERT INTO PRIZE VALUES('1002', 'Data Prediction', '112');
INSERT INTO PRIZE VALUES('1002', 'Data Search', '114');
INSERT INTO PRIZE VALUES('1003', 'System Design', '105');
INSERT INTO PRIZE VALUES('1003', 'System Optimization', '107');
INSERT INTO PRIZE VALUES('1003', 'Data Prediction', '112');
INSERT INTO PRIZE VALUES('1004', 'System Design', '105');
INSERT INTO PRIZE VALUES('1004', 'Data Prediction', '112');
INSERT INTO PRIZE VALUES('1004', 'Software Development', '117');
INSERT INTO PRIZE VALUES('1005', 'System Optimization', '107');
INSERT INTO PRIZE VALUES('1006', 'Software Development', '117');

INSERT INTO EQUIPMENT VALUES('Weather Data', '102', 'Database Systems', '3', '40', '5');
INSERT INTO EQUIPMENT VALUES('System Data', '104', 'Distributed Systems', '3', '50', '20');
INSERT INTO EQUIPMENT VALUES('Figure Data', '110', 'Computer Vision', '3', '10', '5');
INSERT INTO EQUIPMENT VALUES('Health Data', '112', 'Machine Learning', '4', '20', '15');
INSERT INTO EQUIPMENT VALUES('Traffic Data', '117', 'Database Systems', '3', '30', '20');
INSERT INTO EQUIPMENT VALUES('Software Data', '104', 'Operating Systems', '2', '40', '10');
INSERT INTO EQUIPMENT VALUES('Image Data', '106', 'Computer Vision', '3', '20', '10');
INSERT INTO EQUIPMENT VALUES('Hardware Data', '110', 'Operating Systems', '2', '30', '20');

INSERT INTO BORROWS VALUES('Weather Data', 'Data Analytics', '102', TO_DATE('1/13/2017','MM/DD/YYYY'));
INSERT INTO BORROWS VALUES('Weather Data', 'Data Prediction', '112', TO_DATE('1/10/2017','MM/DD/YYYY'));
INSERT INTO BORROWS VALUES('Weather Data', 'Data Search', '114', TO_DATE('3/1/2017','MM/DD/YYYY'));
INSERT INTO BORROWS VALUES('Weather Data', 'Software Development', '117', TO_DATE('1/5/2017','MM/DD/YYYY'));
INSERT INTO BORROWS VALUES('System Data', 'Data Analytics', '102', TO_DATE('1/9/2017','MM/DD/YYYY'));
INSERT INTO BORROWS VALUES('System Data', 'Image Recognition', '106', TO_DATE('2/16/2017','MM/DD/YYYY'));
INSERT INTO BORROWS VALUES('System Data', 'System Optimization', '107', TO_DATE('2/20/2017','MM/DD/YYYY'));
INSERT INTO BORROWS VALUES('System Data', 'Data Prediction', '112', TO_DATE('1/1/2017','MM/DD/YYYY'));
INSERT INTO BORROWS VALUES('System Data', 'Software Development', '117', TO_DATE('2/25/2017','MM/DD/YYYY'));
INSERT INTO BORROWS VALUES('Figure Data', 'Image Recognition', '106', TO_DATE('3/15/2017','MM/DD/YYYY'));
INSERT INTO BORROWS VALUES('Health Data', 'Data Search', '114', TO_DATE('1/19/2017','MM/DD/YYYY'));
INSERT INTO BORROWS VALUES('Traffic Data', 'Data Prediction', '112', TO_DATE('1/16/2017','MM/DD/YYYY'));
INSERT INTO BORROWS VALUES('Traffic Data', 'Data Search', '114', TO_DATE('2/28/2017','MM/DD/YYYY'));
INSERT INTO BORROWS VALUES('Software Data', 'Data Analytics', '102', TO_DATE('2/26/2017','MM/DD/YYYY'));
INSERT INTO BORROWS VALUES('Software Data', 'System Optimization', '107', TO_DATE('1/18/2017','MM/DD/YYYY'));
INSERT INTO BORROWS VALUES('Software Data', 'Data Prediction', '112', TO_DATE('2/10/2017','MM/DD/YYYY'));
INSERT INTO BORROWS VALUES('Software Data', 'Software Development', '117', TO_DATE('1/26/2017','MM/DD/YYYY'));
INSERT INTO BORROWS VALUES('Software Data', 'Image Reconstruction', '119', TO_DATE('3/17/2017','MM/DD/YYYY'));
INSERT INTO BORROWS VALUES('Image Data', 'Image Recognition', '106', TO_DATE('3/10/2017','MM/DD/YYYY'));
INSERT INTO BORROWS VALUES('Image Data', 'Image Reconstruction', '119', TO_DATE('4/1/2017','MM/DD/YYYY'));
INSERT INTO BORROWS VALUES('Hardware Data', 'Data Analytics', '102', TO_DATE('4/5/2017','MM/DD/YYYY'));
INSERT INTO BORROWS VALUES('Hardware Data', 'System Design', '105', TO_DATE('4/1/2017','MM/DD/YYYY'));
INSERT INTO BORROWS VALUES('Hardware Data', 'System Optimization', '107', TO_DATE('4/5/2017','MM/DD/YYYY'));

INSERT INTO TEACHES VALUES('Database Systems', '3', '103', '102', TO_DATE('2/6/2017','MM/DD/YYYY'));
INSERT INTO TEACHES VALUES('Database Systems', '3', '115', '103', TO_DATE('3/10/2017','MM/DD/YYYY'));
INSERT INTO TEACHES VALUES('Machine Learning', '4', '102', '105', TO_DATE('3/8/2017','MM/DD/YYYY'));
INSERT INTO TEACHES VALUES('Machine Learning', '4', '105', '115', TO_DATE('7/5/2017','MM/DD/YYYY'));
INSERT INTO TEACHES VALUES('Algorithms', '2', '116', '109', TO_DATE('1/9/2017','MM/DD/YYYY'));
INSERT INTO TEACHES VALUES('Database Systems', '4', '102', '111', TO_DATE('2/2/2017','MM/DD/YYYY'));
INSERT INTO TEACHES VALUES('Distributed Systems', '3', '111', '112', TO_DATE('1/20/2017','MM/DD/YYYY'));
INSERT INTO TEACHES VALUES('Distributed Systems', '3', '112', '109', TO_DATE('1/1/2017','MM/DD/YYYY'));
INSERT INTO TEACHES VALUES('Machine Learning', '1', '120', '112', TO_DATE('2/16/2017','MM/DD/YYYY'));
INSERT INTO TEACHES VALUES('Machine Learning', '1', '109', '114', TO_DATE('1/1/2017','MM/DD/YYYY'));
INSERT INTO TEACHES VALUES('Operating Systems', '2', '111', '120', TO_DATE('3/4/2017','MM/DD/YYYY'));
INSERT INTO TEACHES VALUES('Computer Vision', '3', '105', '115', TO_DATE('1/6/2017','MM/DD/YYYY'));
INSERT INTO TEACHES VALUES('Computer Vision', '3', '111', '116', TO_DATE('1/7/2017','MM/DD/YYYY'));

/*********************************
 INSERT YOUR SOLUTIONS OF PART 04
*********************************/

/* 1.Look at the structure of Person table, and insert a person called 'David Bowie' with ID-number '121'.*/ 
INSERT INTO PERSON (IDNUMBER , NAME , PHONE)
VALUES ( '121' , 'David Bowie' , NULL);

/* 2.Look at the structure of Prize table, and delete the prizes with prizeID '1005'.*/
DELETE
FROM PRIZE
WHERE PRIZEID = '1005' ;

/* 3.Produce table Answer01 (Project_Name, Person_ID) which contains all the projects 
which don't win any prizes and which borrow at least two equipments, and their leader's ID.*/

/* TEMP0: Mapping (Project Name , ID_Number) between PROJECT and PRIZE */
CREATE TABLE TEMP0 AS
SELECT PROJECT.NAME AS Project_NAME , PRIZE.IDNUMBER AS Person_ID
FROM PROJECT , PRIZE
WHERE PROJECT.NAME = PRIZE.NAME AND PROJECT.IDNUMBER = PRIZE.IDNUMBER;

/* TEMP1: Find out project do not win any prizes */
CREATE TABLE TEMP1 AS
SELECT PROJECT.NAME AS Project_Name , PROJECT.IDNUMBER AS Person_ID
FROM PROJECT
MINUS
SELECT TEMP0.Project_Name , TEMP0.Person_ID
FROM TEMP0; 

/* TEMP2: Mapping (Project Name , Person_ID , Equipment Name) between TEMP1 and Borrows */
CREATE TABLE TEMP2 AS
SELECT BORROWS.PROJNAME AS Project_Name , BORROWS.EQUIPNAME AS EquipName, TEMP1.Person_ID AS Person_ID
FROM BORROWS , TEMP1
WHERE BORROWS.PROJNAME = TEMP1.Project_Name AND BORROWS.MEMBERID = TEMP1.Person_ID;

/* TEMP3: Mapping (Project Name , Person_ID , EquipName , UseAmount) between TEMP2 and EQUIPMENT*/
CREATE TABLE TEMP3 AS
SELECT TEMP2.Project_Name AS Project_Name , TEMP2.Person_ID AS Person_ID , EQUIPMENT.Name AS EquipName
FROM TEMP2 , EQUIPMENT
WHERE EQUIPMENT.NAME = TEMP2.EquipName;

/* TEMP4: Mapping counting to TEMP3*/
CREATE TABLE TEMP4 AS
SELECT Project_Name , Person_ID , COUNT(Project_Name) AS Counts
FROM TEMP3
GROUP BY Project_Name , Person_ID
HAVING COUNT(Project_Name) >= 2;

/* CREATE TABLE ANSWER01 AS */
CREATE TABLE ANSWER01 AS
SELECT Project_Name , Person_ID
FROM TEMP4
ORDER BY Project_Name ASC , Person_ID ASC;

/* 4.Produce table Answer02 (Person_Name) which contains all the people with two identities: 
	The person is a member who leads a project with two or more prizes, and also a coach who teaches at least one course.*/

/* TEMP5: MAPPING PrizeID to TEMP0 */
CREATE TABLE TEMP5 AS
SELECT TEMP0.Project_NAME AS Project_Name , TEMP0.Person_ID AS Person_ID , PRIZE.PRIZEID AS PrizeID
FROM TEMP0 , PRIZE
WHERE TEMP0.Person_ID = PRIZE.IDNUMBER AND TEMP0.Project_Name = PRIZE.NAME;

/* TEMP6: Member who leads a project with two or more prizes */
CREATE TABLE TEMP6 AS
SELECT TEMP5.Person_ID AS Person_ID
FROM TEMP5
GROUP BY Person_ID
HAVING COUNT(Person_ID) >= 2;

/* TEMP7: MAPPING (ID_Number , Name , Level) between TEACHES and COURSE */
CREATE TABLE TEMP7 AS
SELECT TEACHES.IDNUMBER AS ID , COURSE.NAME AS Name , COURSE.LVL AS LVL
FROM TEACHES , COURSE
WHERE TEACHES.NAME = COURSE.NAME AND TEACHES.LVL = COURSE.LVL;

/* TEMP8: Coach who teaches at least one course.*/
CREATE TABLE TEMP8 AS
SELECT ID AS Person_ID
FROM TEMP7
GROUP BY ID
HAVING COUNT(ID) >= 1;

/* TEMP9: Mapping ID in both Coach and Member */
CREATE TABLE TEMP9 AS 
SELECT Person_ID
FROM TEMP6
INTERSECT
SELECT Person_ID
FROM TEMP8;

/* TEMP10: Mapping ID with Name */
CREATE TABLE TEMP10 AS
SELECT Person.NAME AS Person_Name , TEMP9.Person_ID AS Person_ID
FROM PERSON , TEMP9
WHERE TEMP9.Person_ID = PERSON.IDNUMBER;

/* CREATE TABLE ANSWER02 AS */
CREATE TABLE ANSWER02 AS
SELECT Person_Name
FROM TEMP10
ORDER BY Person_Name ASC;


/* 5.Produce table Answer03 (Person_ID) which contains all the members who lead projects that borrow all the equipments 
	with amount greater than 35.*/

/* TEMP11: Mapping (EquipName , PERSON_ID) between EQUIPMENT AND BORROWS */
CREATE TABLE TEMP11 AS
SELECT EQUIPMENT.NAME AS EquipName, BORROWS.MEMBERID AS PERSON_ID
FROM EQUIPMENT, BORROWS
WHERE EQUIPMENT.AMOUNT > 35;

/* TEMP12: TEMP11 - BORROWS */
CREATE TABLE TEMP12 AS
SELECT TEMP11.EquipName AS EquipName, TEMP11.PERSON_ID AS PERSON_ID
FROM TEMP11
WHERE NOT EXISTS (SELECT EquipName AS EquipName, MEMBERID AS PERSON_ID
FROM BORROWS
WHERE TEMP11.EquipName = BORROWS.EquipName
AND TEMP11.PERSON_ID = BORROWS.MEMBERID);

/* CREATE TABLE ANSWER03 AS */
CREATE TABLE ANSWER03 AS
SELECT DISTINCT BORROWS.MEMBERID AS PERSON_ID
FROM BORROWS
WHERE NOT EXISTS 
(SELECT TEMP12.PERSON_ID
FROM TEMP12
WHERE TEMP12.PERSON_ID = BORROWS.MEMBERID)
ORDER BY PERSON_ID ASC;

spool N10912051_Homework04Spool.txt;
SELECT * FROM PERSON;
SELECT * FROM PRIZE;
SELECT * FROM ANSWER01;
SELECT * FROM ANSWER02;
SELECT * FROM ANSWER03;

/* 6.Suppose that the attribute supervisor of coach is transitive. 
	That is, because a person can be both a coach and a manager, the supervisor of a manager(coach) 
	is also the supervisor of the coach he or she supervised. 
	Produce table Answer04 (Coach_ID, Supervisor_ID) which contains all the coaches and their supervisors as defined above.*/
WITH ANSWER04(Coach_ID, Supervisor_ID) AS
(
SELECT COACH.IDNUMBER , COACH.SUPERVISOR
FROM COACH
WHERE COACH.SUPERVISOR IS NOT NULL
UNION ALL
SELECT COACH.IDNUMBER , ANSWER04.Supervisor_ID
FROM ANSWER04
JOIN COACH
ON COACH.SUPERVISOR = ANSWER04.Coach_ID
WHERE COACH.SUPERVISOR IS NOT NULL
)
SELECT * FROM ANSWER04
ORDER BY Coach_ID ASC , Supervisor_ID ASC;

/* 7.Create view Answer05(Project_Name, Membership_Type) which contains the project names a member leads,
	and their membership types. Now, by running the existing script, from which you should not remove the 
	existing update of the view, it should give you an error saying that 
	"cannot modify a column which maps to a non key-preserved table".

	To resolve this, create a trigger Trigger01 that is triggered when you try to update an entry of the view. 
	Any update of the view must also be reflected in the base tables using this trigger.*/

CREATE VIEW ANSWER05 AS
SELECT PROJECT.NAME AS Project_Name , MEMBER.MEMBERSHIP AS Membership_Type
FROM PROJECT , MEMBER
WHERE PROJECT.IDNUMBER = MEMBER.IDNUMBER
ORDER BY Project_Name ASC , MEMBERSHIP ASC;

SELECT * FROM ANSWER05;

UPDATE ANSWER05
SET Membership_Type = 'planB'
WHERE Project_Name = 'Data Prediction';

/* Create trigger Trigger01 */
CREATE TRIGGER TRIGGER01
INSTEAD OF UPDATE ON ANSWER05
REFERENCING NEW AS new
BEGIN
UPDATE MEMBER
SET MEMBERSHIP = :new.Membership_Type
WHERE MEMBER.IDNUMBER IN
(SELECT MEMBER.IDNUMBER
FROM MEMBER, PROJECT
WHERE PROJECT.IDNUMBER = MEMBER.IDNUMBER AND PROJECT.NAME = :old.Project_Name);
END TRIGGER01;
/

UPDATE ANSWER05
SET Membership_Type = 'planB'
WHERE Project_Name = 'Data Prediction';

SELECT * FROM ANSWER05;
SELECT * FROM MEMBER;

spool off;